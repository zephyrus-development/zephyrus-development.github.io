<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zephyrus - Secure File Sharing</title>
    
    <!-- Favicon & Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="../images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
    <link rel="manifest" href="../images/manifest.json">
    <meta name="msapplication-TileColor" content="#7431ff">
    <meta name="msapplication-TileImage" content="../images/ms-icon-144x144.png">
    <meta name="theme-color" content="#7431ff">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Shared File via Zephyrus">
    <meta property="og:description" content="View securely shared file">
    <meta property="og:type" content="website">
    <meta property="og:image" content="../images/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="../images/twitter-image.png">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .shared-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
        }

        .shared-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .shared-header h1 {
            margin-bottom: 10px;
            background: linear-gradient(135deg, #7431ff 0%, #9d6eff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .shared-header .subtitle {
            font-size: 0.95rem;
            color: #a0a0a0;
        }

        .shared-status-box {
            background: rgba(116, 49, 255, 0.05);
            border: 1px solid rgba(116, 49, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-text {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .status-message {
            color: #e0e0e0;
            font-size: 1.1rem;
            font-weight: 500;
            word-break: break-word;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(116, 49, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7431ff 0%, #9d6eff 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7431ff 0%, #9d6eff 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(116, 49, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(116, 49, 255, 0.2);
            color: #e0e0e0;
            border: 1px solid rgba(116, 49, 255, 0.3);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(116, 49, 255, 0.3);
            border-color: #7431ff;
        }

        #retryBtn {
            max-width: none;
            flex: 1;
        }

        .error {
            color: #ff8a80;
            background: rgba(211, 47, 47, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #d32f2f;
        }

        .success {
            color: #81c784;
            background: rgba(76, 175, 80, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .info-box {
            background: rgba(33, 150, 243, 0.1);
            color: #64b5f6;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 20px;
            line-height: 1.6;
            border-left: 4px solid #2196f3;
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top: 2px solid #7431ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-name {
            font-family: 'Courier New', monospace;
            background: rgba(116, 49, 255, 0.1);
            color: #9d6eff;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 12px 0;
            word-break: break-all;
            border: 1px solid rgba(116, 49, 255, 0.2);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="shared-container">
        <header class="shared-header">
            <div class="logo">üîê</div>
            <h1><a href="../" style="text-decoration: none; color: inherit;">Zephyrus Secure Sharing</a></h1>
            <p class="subtitle">Decrypting your shared file...</p>
        </header>

        <div id="errorBox" class="error hidden"></div>
        <div id="successBox" class="success hidden"></div>

        <div class="shared-status-box">
            <div class="status-text">Status</div>
            <div class="status-message" id="statusMessage">
                <div class="spinner"></div> Preparing...
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div id="fileInfo" class="hidden">
            <div class="file-name" id="fileName"></div>
        </div>

        <div class="button-group">
            <button id="viewBtn" class="btn-primary hidden" onclick="viewFile()">
                üëÅÔ∏è View File
            </button>
            <button id="downloadBtn" class="btn-secondary hidden" onclick="downloadFile()">
                üì• Download File
            </button>
            <button id="retryBtn" class="btn-secondary hidden" onclick="location.reload()">
                üîÑ Retry
            </button>
        </div>

        <div class="info-box">
            <strong>üîí Privacy Notice:</strong><br>
            This file is decrypted entirely in your browser. Your file and password never leave your device.
        </div>
    </div>

    <script>
        const SALT_SIZE = 16;
        const NONCE_SIZE = 12;
        const ITERATIONS = 100000;

        let decryptedData = null;
        let fileName = null;
        let mimeType = 'application/octet-stream';

        async function main() {
            try {
                // Parse share string from URL hash
                const hash = window.location.hash.substring(1);
                if (!hash) {
                    throw new Error('No share string provided. Please use a share link.');
                }

                const parts = hash.split(':');
                if (parts.length < 3 || parts.length > 4) {
                    throw new Error('Invalid share string format.');
                }

                const username = parts[0];
                const reference = parts[1];
                const password = parts[2];
                let encodedFileName = parts[3];

                if (!username || !reference || !password) {
                    throw new Error('Invalid share string - missing components.');
                }

                // Decode filename if provided in share string
                if (encodedFileName) {
                    try {
                        const decodedBytes = Uint8Array.from(atob(encodedFileName), c => c.charCodeAt(0));
                        fileName = new TextDecoder().decode(decodedBytes);
                    } catch (e) {
                        console.warn('Could not decode filename:', e);
                        fileName = null;
                    }
                }

                updateStatus('Fetching share pointer...');
                setProgress(20);

                // Fetch the share pointer from GitHub
                const pointerUrl = `https://raw.githubusercontent.com/${username}/.zephyrus/master/shared/${reference}`;
                const pointerResponse = await fetch(pointerUrl);

                if (!pointerResponse.ok) {
                    throw new Error(`Failed to fetch share pointer (${pointerResponse.status}). File may not exist or reference may be incorrect.`);
                }

                const pointerBuffer = await pointerResponse.arrayBuffer();

                updateStatus('Decrypting share pointer...');
                setProgress(35);

                // Decrypt the pointer with the share password
                let decryptedPointer;
                try {
                    decryptedPointer = await decryptFile(pointerBuffer, password);
                } catch (e) {
                    throw new Error(`Failed to decrypt share pointer: ${e.message}`);
                }

                let pointerData;
                try {
                    const pointerText = new TextDecoder().decode(decryptedPointer);
                    pointerData = JSON.parse(pointerText);
                } catch (e) {
                    throw new Error(`Invalid pointer data: ${e.message}. Share may be corrupted or using old format.`);
                }

                if (!pointerData.storageID || !pointerData.fileKey) {
                    throw new Error('Invalid share pointer - missing storageID or fileKey.');
                }

                updateStatus('Fetching encrypted file...');
                setProgress(50);

                // Fetch the actual encrypted file using the storage ID from the pointer
                const fileUrl = `https://raw.githubusercontent.com/${username}/.zephyrus/master/${pointerData.storageID}`;
                const fileResponse = await fetch(fileUrl);

                if (!fileResponse.ok) {
                    throw new Error(`Failed to fetch file (${fileResponse.status}).`);
                }

                const encryptedFileBuffer = await fileResponse.arrayBuffer();

                updateStatus('Decrypting file...');
                setProgress(75);

                // The file key is stored as raw hex bytes in the pointer (not encrypted)
                let fileKey;
                try {
                    fileKey = hexToBuffer(pointerData.fileKey);
                    if (fileKey.length !== 32) {
                        throw new Error(`Invalid file key length: expected 32 bytes, got ${fileKey.length}`);
                    }
                } catch (e) {
                    throw new Error(`Failed to parse file key: ${e.message}`);
                }

                updateStatus('Decompressing file...');
                setProgress(90);

                // Decrypt the file content with the file key
                try {
                    decryptedData = await decryptFileWithKey(encryptedFileBuffer, fileKey);
                } catch (e) {
                    throw new Error(`Failed to decrypt file content: ${e.message}`);
                }

                updateStatus('File ready to view');
                setProgress(100);

                // Use provided filename or derive from reference
                if (!fileName) {
                    fileName = `zephyrus_file_${reference}.bin`;
                }

                // Determine MIME type from filename
                determineMimeType(fileName);

                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('fileName').textContent = fileName;

                document.getElementById('viewBtn').classList.remove('hidden');
                document.getElementById('downloadBtn').classList.remove('hidden');
                document.getElementById('statusMessage').innerHTML = '‚úÖ File decrypted successfully!';

                // Show success message
                const successBox = document.getElementById('successBox');
                successBox.textContent = 'File is ready to view or download. Click the button below to get started.';
                successBox.classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error: ' + error.message, true);
                document.getElementById('retryBtn').classList.remove('hidden');
            }
        }

        function determineMimeType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const mimeTypes = {
                'txt': 'text/plain',
                'json': 'application/json',
                'html': 'text/html',
                'htm': 'text/html',
                'xml': 'application/xml',
                'csv': 'text/csv',
                'md': 'text/markdown',
                'js': 'application/javascript',
                'css': 'text/css',
                'pdf': 'application/pdf',
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'webp': 'image/webp',
                'svg': 'image/svg+xml'
            };
            mimeType = mimeTypes[ext] || 'application/octet-stream';
        }

        async function decryptFile(encryptedData, password) {
            // Extract salt and nonce
            const view = new Uint8Array(encryptedData);
            const salt = view.slice(0, SALT_SIZE);
            const nonce = view.slice(SALT_SIZE, SALT_SIZE + NONCE_SIZE);
            const ciphertext = view.slice(SALT_SIZE + NONCE_SIZE);

            // Derive key using PBKDF2
            const keyMaterial = await window.crypto.subtle.importKey(
                'raw',
                new TextEncoder().encode(password),
                'PBKDF2',
                false,
                ['deriveBits']
            );

            const derivedBits = await window.crypto.subtle.deriveBits(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: ITERATIONS,
                    hash: 'SHA-256'
                },
                keyMaterial,
                256
            );

            const key = await window.crypto.subtle.importKey(
                'raw',
                derivedBits,
                'AES-GCM',
                false,
                ['decrypt']
            );

            // Decrypt using AES-GCM
            const decrypted = await window.crypto.subtle.decrypt(
                {
                    name: 'AES-GCM',
                    iv: nonce
                },
                key,
                ciphertext
            );

            return new Uint8Array(decrypted);
        }

        async function decryptFileWithKey(encryptedData, keyBuffer) {
            // Format: [Nonce (12 bytes)][Ciphertext]
            // Note: No salt when using raw key (unlike PBKDF2 mode)
            const view = new Uint8Array(encryptedData);
            const nonce = view.slice(0, NONCE_SIZE);
            const ciphertext = view.slice(NONCE_SIZE);

            // Import the provided key directly (already 32 bytes of raw key material)
            const key = await window.crypto.subtle.importKey(
                'raw',
                keyBuffer,
                'AES-GCM',
                false,
                ['decrypt']
            );

            // Decrypt using AES-GCM
            const decrypted = await window.crypto.subtle.decrypt(
                {
                    name: 'AES-GCM',
                    iv: nonce
                },
                key,
                ciphertext
            );

            return new Uint8Array(decrypted);
        }

        function hexToBuffer(hexString) {
            // Convert hex string to Uint8Array
            const bytes = new Uint8Array(hexString.length / 2);
            for (let i = 0; i < hexString.length; i += 2) {
                bytes[i / 2] = parseInt(hexString.substr(i, 2), 16);
            }
            return bytes;
        }

        function updateStatus(message, isError = false) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;

            if (isError) {
                const errorBox = document.getElementById('errorBox');
                errorBox.textContent = message;
                errorBox.classList.remove('hidden');
            }
        }

        function setProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function viewFile() {
            if (!decryptedData) {
                alert('No file data available');
                return;
            }

            try {
                // Create a blob from the decrypted data
                const blob = new Blob([decryptedData], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                
                // Open in a new tab
                window.open(url, '_blank');
            } catch (e) {
                console.error('Could not open file:', e);
                alert('Failed to open file');
            }
        }

        function downloadFile() {
            if (!decryptedData) {
                alert('No file data available');
                return;
            }

            const blob = new Blob([decryptedData], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName || 'download';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Start the process
        window.addEventListener('load', main);
    </script>

    <footer>
        <p>Made with ‚ù§Ô∏è for the privacy-conscious community</p>
        <p>¬© 2026 Zephyrus CLI. MIT License.</p>
    </footer>
</body>
</html>
